I"‰?<h1 id="-kubernetes-ì„¤ì¹˜"><img src="/assets/images/icon/Kubernetes_Logo_Hrz_lockup_REV1.png" alt="kubernetes icon" class="icon-title" /> Kubernetes ì„¤ì¹˜</h1>

<ul>
  <li><a href="#ã…‘nstalling-kubeadm-kubelet-and-kubectl">Installing kubeadm, kubelet and kubectl</a>
    <ul>
      <li><a href="#-docker-ì„¤ì¹˜">Docker ì„¤ì¹˜</a></li>
    </ul>
  </li>
  <li><a href="#kubeadm-init-ì‹¤í–‰">kubeadm init ì‹¤í–‰</a></li>
  <li><a href="#kubernetes-dashboard-ì„¤ì¹˜">kubernetes dashboard ì„¤ì¹˜</a>
    <ul>
      <li><a href="#dashboard-ê¸°ë™-ë°©ë²•">dashboard ê¸°ë™ ë°©ë²•</a></li>
    </ul>
  </li>
  <li><a href="#kubernetes-dashboard---metrics-server-ì„¤ì¹˜">kubernetes dashboard - (metrics server) ì„¤ì¹˜</a>
    <ul>
      <li><a href="#-certificate">Certificate</a></li>
    </ul>
  </li>
</ul>

<p class="desc-text">Ubuntu 20.04 Docker ì ìš©</p>

<h1 id="installing-kubeadm-kubelet-and-kubectl">Installing kubeadm, kubelet and kubectl</h1>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> <span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> apt-transport-https curl

curl <span class="nt">-s</span> https://packages.cloud.google.com/apt/doc/apt-key.gpg | <span class="nb">sudo </span>apt-key add -

<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/apt/sources.list.d/kubernetes.list
deb https://apt.kubernetes.io/ kubernetes-xenial main
</span><span class="no">EOF

</span><span class="nb">sudo </span>apt-get update

<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="nt">-y</span> kubelet kubeadm kubectl

<span class="nb">sudo </span>apt-mark hold kubelet kubeadm kubectl
</code></pre></div></div>

<h4 id="-docker-ì„¤ì¹˜"><img src="/assets/images/icon/docker.svg" alt="docker icon" class="icon-title" /> <a href="/docker">Docker ì„¤ì¹˜</a></h4>

<h1 id="kubeadm-init-ì‹¤í–‰">kubeadm init ì‹¤í–‰</h1>

<p class="desc-text">apiserver-advertise-address ì—ëŠ” ifconfig ë‚˜ì˜¤ëŠ” ens5 ë§ˆìŠ¤í„° ë…¸ë“œì˜ ipë¥¼ ì ëŠ”ë‹¤</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># images pull í›„ì— ì‹¤í–‰</span>
<span class="nb">sudo </span>kubeadm config images pull

<span class="nb">sudo </span>kubeadm init <span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16 <span class="nt">--apiserver-advertise-address</span><span class="o">=</span>10.10.0.151
</code></pre></div></div>

<p class="desc-text">â€“ woker node ì— ì ìš©ë  ê²°ê³¼</p>

<p class="desc-text">sudo kubeadm join â€“node-name node-worker-01 10.10.0.154:6443 â€“token k7z4hy.5f47ac9h5bmpwikn â€“discovery-token-ca-cert-hash sha256:d99f25181a5581a74b8fa319f2caa16635923b247493ae87b9dc12f801c9f204</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># token ë§Œë£Œì´í›„ ë‹¤ì‹œ ì¡°íšŒ ìƒì„± í•˜ëŠ” command</span>
<span class="c"># 1) í† í°ì„ ëª¨ë¥¼ ê²½ìš°</span>
<span class="nb">sudo </span>kubeadm token list
<span class="c"># 2) í† í°ì´ ì—†ëŠ” ê²½ìš° (ê¸°ë³¸ 24ì‹œê°„ í›„ ì‚­ì œ)</span>
<span class="nb">sudo </span>kubeadm token create
<span class="c"># 3) --discovery-token-ca-cert-hashë¥¼ ëª¨ë¥¼ ê²½ìš°</span>
openssl x509 <span class="nt">-pubkey</span> <span class="nt">-in</span> /etc/kubernetes/pki/ca.crt | openssl rsa <span class="nt">-pubin</span> <span class="nt">-outform</span> der 2&gt;/dev/null | openssl dgst <span class="nt">-sha256</span> <span class="nt">-hex</span> | <span class="nb">sed</span> <span class="s1">'s/^.* //'</span>
</code></pre></div></div>

<p>nodeì—ì„œ master ì— joiní›„ì— nodeì— taint ë¥¼ ì£¼ë ¤ê³  í•˜ëŠ” ê²½ìš°</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># taint ì¶”ê°€</span>
kubectl taint node node-worker-1 <span class="nv">key1</span><span class="o">=</span>value1:NoSchedule

<span class="c"># taint ì œê±°</span>
kubectl taint nodes node-worker-1 key1-
</code></pre></div></div>

<p>ì…‹ì—…í•œ í´ëŸ¬ìŠ¤í„° ì‚¬ìš© ëª…ë ¹ì–´</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
<span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config
</code></pre></div></div>

<p>í•´ë‹¹ ëª…ë ¹ì–´ëŠ” Root ê³„ì •ì´ ì•„ë‹Œ ë‹¤ë¥¸ ì‚¬ìš©ì ê³„ì •ì—ì„œ kubectl ì»¤ë§¨ë“œ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ë¥¼ ì œì–´í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ì–´ì´ë‹¤.</p>

<p class="desc-text"><br />
ë§Œì•½ ë‹¤ë¥¸ ì»´í“¨í„°ì—ì„œ kubectlì„ ì‚¬ìš©í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ì™€ í†µì‹ í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ admin.conf íŒŒì¼ì„ ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ë³µì‚¬í•´ì™€ì„œ kubectl â€“kubeconfig ëª…ë ¹ì–´ë¥¼ í†µí•´ ê°€ëŠ¥í•˜ë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp ubuntu@&lt;ë§ˆìŠ¤í„° ë…¸ë“œ IP&gt;:/etc/kubernetes/admin.conf <span class="nb">.</span>
kubectl <span class="nt">--kubeconfig</span> ./admin.conf get nodes
</code></pre></div></div>

<p class="desc-text">ë˜í•œ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ë§ˆìŠ¤í„° ë…¸ë“œì˜ API ì„œë²„ì— ì—°ê²°í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ì™€ ê°™ì´ <code class="language-plaintext highlighter-rouge">kubectl proxy</code> ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>scp ubuntu@&lt;ë§ˆìŠ¤í„° ë…¸ë“œ IP&gt;:/etc/kubernetes/admin.conf <span class="nb">.</span>
kubectl <span class="nt">--kubeconfig</span> ./admin.conf proxy
</code></pre></div></div>

<p>ê·¸ ë‹¤ìŒì€ ìš°ë¦¬ê°€ ì‚¬ìš©í•  Pod ë„¤íŠ¸ì›Œí¬ ì• ë“œì˜¨(Flannel)ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ì•„ë˜ì˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ Pod ë„¤íŠ¸ì›Œí¬ë¥¼ í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í•œë‹¤.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre></div></div>

<p class="desc-text">10.0.0.0/8 ëŒ€ì—­ì˜ ë°©í™”ë²½ì„ ì—´ì–´ë†”ì•¼í•¨ - kubeadm init ì‹œì— 10.244.0.0/16 ëŒ€ì—­ì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ê° node ê°„ ë°©í™”ë²½ì´ ë™ì‘í•˜ì§€ ì•Šë„ë¡ ì£¼ì˜</p>

<p class="desc-text">flannel ì„¤ì •ì‹œ í•˜ë‹¨ì˜ ë©”ì‹œì§€ê°€ ë‚˜ì˜¤ëŠ”ê±´ ìœ„ì˜ ì…‹ì—…í•œ í´ëŸ¬ìŠ¤í„° ì‚¬ìš© ëª…ë ¹ì–´ ë¥¼ ì ìš©í•˜ì§€ ì•Šì•„ì„œì´ë‹¤.</p>

<p class="desc-text">The connection to the server localhost:8080 was refused - did you specify the right host or port?</p>

<h1 id="kubernetes-dashboard-ì„¤ì¹˜">kubernetes dashboard ì„¤ì¹˜</h1>

<p>ì¶œì²˜ <a href="https://waspro.tistory.com/516">https://waspro.tistory.com/516</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> https://raw.githubusercontent.com/kubernetes/dashboard/v2.2.0/aio/deploy/recommended.yaml
</code></pre></div></div>

<p>kubernetes í™•ì¸</p>

<p><img src="/assets/images/views/kubernetes/Untitled.png" alt="kubernetes í™•ì¸" />
<br />
<br /></p>

<h3 id="dashboard-ê¸°ë™-ë°©ë²•">dashboard ê¸°ë™ ë°©ë²•</h3>

<ul>
  <li><strong>Proxyë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•</strong></li>
  <li><strong>NodePortë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•</strong></li>
  <li><strong>API Serverë¥¼ ì´ìš©í•˜ëŠ”ë°©ë²•</strong></li>
</ul>

<p><br />
 <strong>API Server ì´ìš© ë°©ë²•</strong> - dashboard ê¸°ë™ ë°©ë²• ì¤‘ API Server ë¥¼ ì´ìš©í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì§„í–‰</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep</span> <span class="s1">'client-certificate-data'</span> ~/.kube/config | <span class="nb">head</span> <span class="nt">-n</span> 1 | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;&gt;</span> kubecfg.crt

<span class="nb">grep</span> <span class="s1">'client-key-data'</span> ~/.kube/config | <span class="nb">head</span> <span class="nt">-n</span> 1 | <span class="nb">awk</span> <span class="s1">'{print $2}'</span> | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;&gt;</span> kubecfg.key
</code></pre></div></div>

<p><br />
ë‹¤ìŒìœ¼ë¡œ ìƒì„±í•œ í‚¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ p12 ì¸ì¦ì„œ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤. -  ë¸Œë¼ìš°ì €ì— ê°œë³„ë¡œ ë“±ë¡</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openssl pkcs12 <span class="nt">-export</span> <span class="nt">-clcerts</span> <span class="nt">-inkey</span> kubecfg.key <span class="nt">-in</span> kubecfg.crt <span class="nt">-out</span> kubecfg.p12 <span class="nt">-name</span> <span class="s2">"kubernetes-admin"</span>

Enter Export Password:
Verifying - Enter Export Password:

<span class="nb">ls</span> <span class="nt">-la</span> kubecfg.p12
<span class="nt">-rw-r--r--</span> 1 root root 3262 Aug  3 22:49 kubecfg.p12

</code></pre></div></div>

<p class="desc-text"><strong>kubecfg.p12, /etc/kubernetes/pki/ca.crt</strong> ì¸ì¦ì„œ client pc ë¡œ copy</p>
<p class="desc-text">ca.crt ëŠ” ë™ì¼í•œ ì´ë¦„ìœ¼ë¡œ ê¸°ê´€ì´ ë“±ë¡ë˜ì–´ ìˆì–´ ì—¬ëŸ¬ê°œ ë„ìš¸ë•Œ ì—ëŸ¬ ë°œìƒ</p>

<p><br />
<br />
ca.crt ì¸ì¦ì„œ rootì— ì „ì—­ìœ¼ë¡œ ì„¤ì¹˜ - ca.crt ëŠ” ë“±ë¡í•˜ì§€ ì•Šì•„ë„ ì‚¬ìš© ê°€ëŠ¥</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo mkdir</span> /usr/share/ca-certificates/extra

<span class="nb">sudo cp </span>ca.crt /usr/share/ca-certificates/extra/

<span class="nb">sudo </span>dpkg-reconfigure ca-certificates

</code></pre></div></div>

<p><br />
master ìª½ì—ì„œ í•´ë‹¹ ëª…ë ¹ì–´ë¡œ token get  - í•˜ë‹¨ì˜ kubernetes login ì¸ì¦í‚¤ ìƒì„±ì„ ì‹¤í–‰í›„ í•´ì•¼í•œë‹¤</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> kube-system describe secret <span class="si">$(</span>kubectl <span class="nt">-n</span> kube-system get secret | <span class="nb">grep </span>admin-user | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span>
</code></pre></div></div>

<p><br />
<br /></p>
<ul>
  <li>
    <p><strong>Kubernetes Login ì¸ì¦í‚¤ ìƒì„±</strong></p>
  </li>
  <li>
    <p>KubernetesëŠ” ì ‘ì†ë°©ë²•Â </p>
    <ul>
      <li>kubeconfig</li>
      <li>Token</li>
    </ul>
  </li>
</ul>

<p><br />
<strong>Token ë°©ì‹ ì ìš©</strong></p>

<ul>
  <li>serviceaccount, clusterrolebinding ìƒì„±</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi eks-admin-service-account.yaml

apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin-user
  namespace: kube-system
<span class="nt">---</span>
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: admin-user
  namespace: kube-system
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ì ìš©
kubectl apply <span class="nt">-f</span> eks-admin-service-account.yaml

// ì‚­ì œ
kubectl delete <span class="nt">-f</span> eks-admin-service-account.yaml
</code></pre></div></div>

<p><br />
<br /></p>
<ul>
  <li><del>serviceaccountë¥¼ ìƒì„±</del></li>
  <li>í•˜ë‹¨ ì½”ë“œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create -f -
 apiVersion: v1
 kind: ServiceAccount
 metadata:
   name: admin-user
   namespace: kube-system
</span><span class="no">EOF
</span></code></pre></div></div>

<p><br />
<br /></p>
<ul>
  <li><del>ClusterRoleBindingì„ ìƒì„±</del></li>
  <li>í•˜ë‹¨ ì½”ë“œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | kubectl create --validate=false -f -
 apiVersion: rbac.authorization.k8s.io/v1
 kind: ClusterRoleBinding
 metadata:
   name: admin-user
 roleRef:
   apiGroup: rbac.authorization.k8s.io
   kind: ClusterRole
   name: cluster-admin
 subjects:
 - kind: ServiceAccount
   name: admin-user
   namespace: kube-system
</span><span class="no">EOF
</span></code></pre></div></div>

<p><br /></p>
<ul>
  <li>ì‚¬ìš©ì ê³„ì •ì˜ í† í°ì„ ê°€ì ¸ì™€ì„œ ëŒ€ì‹œë³´ë“œì— ì…ë ¥í•©ë‹ˆë‹¤.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl <span class="nt">-n</span> kube-system describe secret <span class="si">$(</span>kubectl <span class="nt">-n</span> kube-system get secret | <span class="nb">grep </span>admin-user | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span>

Name:         admin-user-token-p9ldd
Namespace:    kube-system
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name<span class="o">=</span>admin-user
              kubernetes.io/service-account.uid<span class="o">=</span>041cb7ec-946a-49b6-8900-6dc90fc08464

Type:  kubernetes.io/service-account-token

Data
<span class="o">====</span>
ca.crt:     1025 bytes
namespace:  11 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3Vu
</code></pre></div></div>

<p><br />
ë¸Œë¼ìš°ì €ì— ì¸ì¦ì„œ ê°œì¸ìš©, ì‹ ë¢°í• ìˆ˜ ìˆëŠ” ê¸°ê´€ ì¸ì¦ì„œ ë“±ë¡ í›„ ì‹¤í–‰í•˜ë©´ ì—´ë¦¼</p>

<p>https://[master_ip]:6443/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/#/login</p>

<h4 id="-elasticsearch"><img src="/assets/images/icon/elastic-elasticsearch.png" alt="elasticsearch icon" class="icon-title" /> <a href="/docker/elasticsearch">Elasticsearch</a></h4>

<h1 id="kubernetes-dashboard---metrics-server-ì„¤ì¹˜">kubernetes dashboard - (metrics server) ì„¤ì¹˜</h1>

<p>cpu, memory usage ë¥¼ í™•ì¸í•˜ë ¤ë©´ metrics server ê°€ ì„¤ì¹˜ë˜ì–´ì•¼í•œë‹¤</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</code></pre></div></div>

<p>ì°¸ê³ : <a href="https://kangwoo.github.io/devops/kubernetes/kubernetes-metrics-server-install/">https://kangwoo.github.io/devops/kubernetes/kubernetes-metrics-server-install/</a></p>

<p><br />
deployments ì— ìˆ˜ì • tolerations ì— ì„ ì–¸í• ê²Œ ìˆë‹¤ë©´ ì¶”ê°€í•´ì•¼í•œë‹¤</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>schedulerName: default-scheduler
tolerations:
- key: [node-role.kubernetes.io/master](http://node-role.kubernetes.io/master)
effect: NoSchedule
- key: key
operator: Equal
value: api
effect: NoSchedule
</code></pre></div></div>

<p>deployments ì— ìˆ˜ì • - â€˜â€“kubelet-insecure-tlsâ€™</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>args:
- '--cert-dir=/tmp'
- '--secure-port=4443'
- '--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname'
- '--kubelet-use-node-status-port'
- '--kubelet-insecure-tls'
</code></pre></div></div>

<h4 id="-kubernetes---kubeadm-ì¸ì¦ì„œ"><img src="/assets/images/icon/certificate-icon-png-10319.png" alt="certificate icon" class="icon-title" /> <a href="/kuebernetes/kubeadm-certificate">kubernetes - kubeadm ì¸ì¦ì„œ</a></h4>
:ET